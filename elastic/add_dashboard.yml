# Don't forget to update the configmap with updated dashboard data
apiVersion: v1
kind: ConfigMap
metadata:
  name: kibana-dashboard
  namespace: elastic
data:
  export.ndjson: |
    {"attributes":{"allowHidden":false,"allowNoIndex":true,"fieldAttrs":"{}","fieldFormatMap":"{}","fields":"[]","name":"metrics-*","runtimeFieldMap":"{}","sourceFilters":"[]","timeFieldName":"@timestamp","title":"metrics-*"},"coreMigrationVersion":"8.8.0","created_at":"2024-08-09T04:50:27.562Z","id":"metrics-*","managed":true,"references":[],"type":"index-pattern","typeMigrationVersion":"8.0.0","updated_at":"2024-08-09T04:53:29.154Z","version":"WzE2LDFd"}
    {"attributes":{"controlGroupInput":{"chainingSystem":"HIERARCHICAL","controlStyle":"oneLine","ignoreParentSettingsJSON":"{\"ignoreFilters\":false,\"ignoreQuery\":false,\"ignoreTimerange\":false,\"ignoreValidations\":false}","panelsJSON":"{\"71a9cbfe-41bf-41b7-a687-ca51adc2390d\":{\"type\":\"optionsListControl\",\"order\":0,\"grow\":false,\"width\":\"medium\",\"explicitInput\":{\"id\":\"71a9cbfe-41bf-41b7-a687-ca51adc2390d\",\"fieldName\":\"prometheus.labels.service\",\"title\":\"Service\",\"grow\":false,\"width\":\"medium\",\"searchTechnique\":\"exact\",\"enhancements\":{},\"selectedOptions\":[\"frontend\"],\"singleSelect\":true}},\"616a10d1-f529-46b6-8f4c-11e6baf78d73\":{\"type\":\"optionsListControl\",\"order\":1,\"grow\":false,\"width\":\"medium\",\"explicitInput\":{\"id\":\"616a10d1-f529-46b6-8f4c-11e6baf78d73\",\"fieldName\":\"prometheus.labels.resource_url\",\"title\":\"Resource Url\",\"grow\":false,\"width\":\"medium\",\"searchTechnique\":\"exact\",\"selectedOptions\":[],\"singleSelect\":true,\"existsSelected\":false,\"enhancements\":{}}}}","showApplySelections":false},"description":"","kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[]}"},"optionsJSON":"{\"useMargins\":true,\"syncColors\":false,\"syncCursor\":true,\"syncTooltips\":false,\"hidePanelTitles\":false}","panelsJSON":"[{\"type\":\"lens\",\"gridData\":{\"x\":0,\"y\":0,\"w\":24,\"h\":15,\"i\":\"8719aabe-46df-40db-b05a-df08420bad2b\"},\"panelIndex\":\"8719aabe-46df-40db-b05a-df08420bad2b\",\"embeddableConfig\":{\"attributes\":{\"title\":\"\",\"visualizationType\":\"lnsXY\",\"type\":\"lens\",\"references\":[{\"type\":\"index-pattern\",\"id\":\"metrics-*\",\"name\":\"indexpattern-datasource-layer-77618a1a-3e11-4d04-aa8e-147eddb8a7cc\"},{\"type\":\"index-pattern\",\"name\":\"a6727c55-9e4c-4442-9e04-fbd50964f5ee\",\"id\":\"metrics-*\"}],\"state\":{\"visualization\":{\"legend\":{\"isVisible\":true,\"position\":\"right\"},\"valueLabels\":\"hide\",\"fittingFunction\":\"Carry\",\"yLeftScale\":\"sqrt\",\"axisTitlesVisibilitySettings\":{\"x\":true,\"yLeft\":true,\"yRight\":true},\"tickLabelsVisibilitySettings\":{\"x\":true,\"yLeft\":true,\"yRight\":true},\"labelsOrientation\":{\"x\":0,\"yLeft\":0,\"yRight\":0},\"gridlinesVisibilitySettings\":{\"x\":true,\"yLeft\":true,\"yRight\":true},\"preferredSeriesType\":\"area_stacked\",\"layers\":[{\"layerId\":\"77618a1a-3e11-4d04-aa8e-147eddb8a7cc\",\"accessors\":[\"8cd5b5f2-1a35-43f9-bd79-fea72cb5c415\",\"5821fb13-ac5e-49c1-82ae-e6f092d7c7bc\",\"42d6d358-613a-483d-b60d-ff5fa1b6f317\"],\"position\":\"top\",\"seriesType\":\"area_stacked\",\"showGridlines\":false,\"layerType\":\"data\",\"colorMapping\":{\"assignments\":[],\"specialAssignments\":[{\"rule\":{\"type\":\"other\"},\"color\":{\"type\":\"loop\"},\"touched\":false}],\"paletteId\":\"eui_amsterdam_color_blind\",\"colorMode\":{\"type\":\"categorical\"}},\"xAccessor\":\"55a49007-b4b6-4605-bc90-a711f263e9a8\",\"yConfig\":[{\"forAccessor\":\"5821fb13-ac5e-49c1-82ae-e6f092d7c7bc\",\"color\":\"#da8b45\"}]}],\"yTitle\":\"Duration\",\"hideEndzones\":false,\"showCurrentTimeMarker\":false,\"curveType\":\"CURVE_MONOTONE_X\",\"endValue\":\"None\",\"valuesInLegend\":false},\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filters\":[{\"meta\":{\"disabled\":false,\"negate\":false,\"alias\":\"There is duration\",\"index\":\"a6727c55-9e4c-4442-9e04-fbd50964f5ee\",\"key\":\"prometheus.duration.value\",\"field\":\"prometheus.duration.value\",\"value\":\"exists\",\"type\":\"exists\"},\"query\":{\"exists\":{\"field\":\"prometheus.duration.value\"}},\"$state\":{\"store\":\"appState\"}}],\"datasourceStates\":{\"formBased\":{\"layers\":{\"77618a1a-3e11-4d04-aa8e-147eddb8a7cc\":{\"columns\":{\"55a49007-b4b6-4605-bc90-a711f263e9a8\":{\"label\":\"@timestamp\",\"dataType\":\"date\",\"operationType\":\"date_histogram\",\"sourceField\":\"@timestamp\",\"isBucketed\":true,\"scale\":\"interval\",\"params\":{\"interval\":\"auto\",\"includeEmptyRows\":true,\"dropPartials\":false}},\"5821fb13-ac5e-49c1-82ae-e6f092d7c7bcX0\":{\"label\":\"Part of 95%\",\"dataType\":\"number\",\"operationType\":\"percentile\",\"sourceField\":\"prometheus.duration.value\",\"isBucketed\":false,\"scale\":\"ratio\",\"params\":{\"percentile\":95},\"customLabel\":true},\"5821fb13-ac5e-49c1-82ae-e6f092d7c7bcX1\":{\"label\":\"Part of 95%\",\"dataType\":\"number\",\"operationType\":\"math\",\"isBucketed\":false,\"scale\":\"ratio\",\"params\":{\"tinymathAst\":{\"type\":\"function\",\"name\":\"divide\",\"args\":[\"5821fb13-ac5e-49c1-82ae-e6f092d7c7bcX0\",1000000],\"location\":{\"min\":0,\"max\":60},\"text\":\"percentile(prometheus.duration.value, percentile=95)/1000000\"}},\"references\":[\"5821fb13-ac5e-49c1-82ae-e6f092d7c7bcX0\"],\"customLabel\":true},\"5821fb13-ac5e-49c1-82ae-e6f092d7c7bc\":{\"label\":\"95%\",\"dataType\":\"number\",\"operationType\":\"formula\",\"isBucketed\":false,\"scale\":\"ratio\",\"params\":{\"formula\":\"percentile(prometheus.duration.value, percentile=95)/1000000\",\"isFormulaBroken\":false},\"references\":[\"5821fb13-ac5e-49c1-82ae-e6f092d7c7bcX1\"],\"customLabel\":true},\"42d6d358-613a-483d-b60d-ff5fa1b6f317X0\":{\"label\":\"Part of 99%\",\"dataType\":\"number\",\"operationType\":\"percentile\",\"sourceField\":\"prometheus.duration.value\",\"isBucketed\":false,\"scale\":\"ratio\",\"params\":{\"percentile\":99},\"customLabel\":true},\"42d6d358-613a-483d-b60d-ff5fa1b6f317X1\":{\"label\":\"Part of 99%\",\"dataType\":\"number\",\"operationType\":\"math\",\"isBucketed\":false,\"scale\":\"ratio\",\"params\":{\"tinymathAst\":{\"type\":\"function\",\"name\":\"divide\",\"args\":[\"42d6d358-613a-483d-b60d-ff5fa1b6f317X0\",1000000],\"location\":{\"min\":0,\"max\":60},\"text\":\"percentile(prometheus.duration.value, percentile=99)/1000000\"}},\"references\":[\"42d6d358-613a-483d-b60d-ff5fa1b6f317X0\"],\"customLabel\":true},\"42d6d358-613a-483d-b60d-ff5fa1b6f317\":{\"label\":\"99%\",\"dataType\":\"number\",\"operationType\":\"formula\",\"isBucketed\":false,\"scale\":\"ratio\",\"params\":{\"formula\":\"percentile(prometheus.duration.value, percentile=99)/1000000\",\"isFormulaBroken\":false},\"references\":[\"42d6d358-613a-483d-b60d-ff5fa1b6f317X1\"],\"customLabel\":true},\"8cd5b5f2-1a35-43f9-bd79-fea72cb5c415X0\":{\"label\":\"Part of 50%\",\"dataType\":\"number\",\"operationType\":\"percentile\",\"sourceField\":\"prometheus.duration.value\",\"isBucketed\":false,\"scale\":\"ratio\",\"params\":{\"percentile\":50},\"customLabel\":true},\"8cd5b5f2-1a35-43f9-bd79-fea72cb5c415X1\":{\"label\":\"Part of 50%\",\"dataType\":\"number\",\"operationType\":\"math\",\"isBucketed\":false,\"scale\":\"ratio\",\"params\":{\"tinymathAst\":{\"type\":\"function\",\"name\":\"divide\",\"args\":[\"8cd5b5f2-1a35-43f9-bd79-fea72cb5c415X0\",1000000],\"location\":{\"min\":0,\"max\":60},\"text\":\"percentile(prometheus.duration.value, percentile=50)/1000000\"}},\"references\":[\"8cd5b5f2-1a35-43f9-bd79-fea72cb5c415X0\"],\"customLabel\":true},\"8cd5b5f2-1a35-43f9-bd79-fea72cb5c415\":{\"label\":\"50%\",\"dataType\":\"number\",\"operationType\":\"formula\",\"isBucketed\":false,\"scale\":\"ratio\",\"params\":{\"formula\":\"percentile(prometheus.duration.value, percentile=50)/1000000\",\"isFormulaBroken\":false},\"references\":[\"8cd5b5f2-1a35-43f9-bd79-fea72cb5c415X1\"],\"customLabel\":true}},\"columnOrder\":[\"55a49007-b4b6-4605-bc90-a711f263e9a8\",\"8cd5b5f2-1a35-43f9-bd79-fea72cb5c415\",\"5821fb13-ac5e-49c1-82ae-e6f092d7c7bc\",\"42d6d358-613a-483d-b60d-ff5fa1b6f317\",\"5821fb13-ac5e-49c1-82ae-e6f092d7c7bcX0\",\"5821fb13-ac5e-49c1-82ae-e6f092d7c7bcX1\",\"42d6d358-613a-483d-b60d-ff5fa1b6f317X0\",\"42d6d358-613a-483d-b60d-ff5fa1b6f317X1\",\"8cd5b5f2-1a35-43f9-bd79-fea72cb5c415X0\",\"8cd5b5f2-1a35-43f9-bd79-fea72cb5c415X1\"],\"incompleteColumns\":{},\"sampling\":1}}},\"indexpattern\":{\"layers\":{}},\"textBased\":{\"layers\":{}}},\"internalReferences\":[],\"adHocDataViews\":{}}},\"enhancements\":{}},\"title\":\"Request duration\"},{\"type\":\"lens\",\"gridData\":{\"x\":24,\"y\":0,\"w\":24,\"h\":15,\"i\":\"8676c67a-fb41-44c6-a1c7-fdf12a8f11ae\"},\"panelIndex\":\"8676c67a-fb41-44c6-a1c7-fdf12a8f11ae\",\"embeddableConfig\":{\"attributes\":{\"title\":\"\",\"visualizationType\":\"lnsXY\",\"type\":\"lens\",\"references\":[{\"id\":\"metrics-*\",\"name\":\"indexpattern-datasource-layer-5ecc3fa0-861c-4d6f-8baf-4e6ec46aa94c\",\"type\":\"index-pattern\"},{\"id\":\"metrics-*\",\"name\":\"344d82d5-26a4-4ef8-9e25-b25d3628d053\",\"type\":\"index-pattern\"}],\"state\":{\"visualization\":{\"legend\":{\"isVisible\":true,\"position\":\"right\"},\"valueLabels\":\"hide\",\"fittingFunction\":\"None\",\"axisTitlesVisibilitySettings\":{\"x\":true,\"yLeft\":true,\"yRight\":true},\"tickLabelsVisibilitySettings\":{\"x\":true,\"yLeft\":true,\"yRight\":true},\"labelsOrientation\":{\"x\":0,\"yLeft\":0,\"yRight\":0},\"gridlinesVisibilitySettings\":{\"x\":true,\"yLeft\":true,\"yRight\":true},\"preferredSeriesType\":\"bar_stacked\",\"layers\":[{\"layerId\":\"5ecc3fa0-861c-4d6f-8baf-4e6ec46aa94c\",\"accessors\":[\"92ff10e6-ea63-4350-8356-c2a24b2389ff\"],\"position\":\"top\",\"seriesType\":\"bar_stacked\",\"showGridlines\":false,\"layerType\":\"data\",\"colorMapping\":{\"assignments\":[{\"rule\":{\"type\":\"matchExactly\",\"values\":[\"0\"]},\"color\":{\"type\":\"categorical\",\"paletteId\":\"eui_amsterdam_color_blind\",\"colorIndex\":0},\"touched\":false},{\"rule\":{\"type\":\"matchExactly\",\"values\":[\"1\"]},\"color\":{\"type\":\"categorical\",\"paletteId\":\"eui_amsterdam_color_blind\",\"colorIndex\":7},\"touched\":true},{\"rule\":{\"type\":\"matchExactly\",\"values\":[\"2\"]},\"color\":{\"type\":\"colorCode\",\"colorCode\":\"#f2360d\"},\"touched\":true}],\"specialAssignments\":[{\"rule\":{\"type\":\"other\"},\"color\":{\"type\":\"loop\"},\"touched\":false}],\"paletteId\":\"eui_amsterdam_color_blind\",\"colorMode\":{\"type\":\"categorical\"}},\"xAccessor\":\"ac084a4a-adc1-4e46-be45-d09a0e52abcd\",\"splitAccessor\":\"0dd25e1c-828a-46fd-94b9-16ad7c50e8b2\"}]},\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filters\":[],\"datasourceStates\":{\"formBased\":{\"layers\":{\"5ecc3fa0-861c-4d6f-8baf-4e6ec46aa94c\":{\"columns\":{\"ac084a4a-adc1-4e46-be45-d09a0e52abcd\":{\"label\":\"@timestamp\",\"dataType\":\"date\",\"operationType\":\"date_histogram\",\"sourceField\":\"@timestamp\",\"isBucketed\":true,\"scale\":\"interval\",\"params\":{\"interval\":\"auto\",\"includeEmptyRows\":true,\"dropPartials\":false}},\"92ff10e6-ea63-4350-8356-c2a24b2389ff\":{\"label\":\"Requests and Errors\",\"dataType\":\"number\",\"operationType\":\"count\",\"isBucketed\":false,\"scale\":\"ratio\",\"sourceField\":\"___records___\",\"params\":{\"emptyAsNull\":true},\"customLabel\":true},\"0dd25e1c-828a-46fd-94b9-16ad7c50e8b2\":{\"label\":\"Top 5 values of prometheus.labels.status_code\",\"dataType\":\"string\",\"operationType\":\"terms\",\"scale\":\"ordinal\",\"sourceField\":\"prometheus.labels.status_code\",\"isBucketed\":true,\"params\":{\"size\":5,\"orderBy\":{\"type\":\"column\",\"columnId\":\"92ff10e6-ea63-4350-8356-c2a24b2389ff\"},\"orderDirection\":\"desc\",\"otherBucket\":true,\"missingBucket\":false,\"parentFormat\":{\"id\":\"terms\"},\"include\":[],\"exclude\":[],\"includeIsRegex\":false,\"excludeIsRegex\":false}}},\"columnOrder\":[\"0dd25e1c-828a-46fd-94b9-16ad7c50e8b2\",\"ac084a4a-adc1-4e46-be45-d09a0e52abcd\",\"92ff10e6-ea63-4350-8356-c2a24b2389ff\"],\"incompleteColumns\":{},\"sampling\":1}}},\"indexpattern\":{\"layers\":{}},\"textBased\":{\"layers\":{}}},\"internalReferences\":[],\"adHocDataViews\":{}}},\"enhancements\":{}},\"title\":\"Requests and errors\"}]","timeRestore":false,"title":"RED Metrics","version":2},"coreMigrationVersion":"8.8.0","created_at":"2024-08-09T04:50:27.562Z","id":"97112449-a74b-4a25-8620-ecb51a37f129","managed":false,"references":[{"id":"metrics-*","name":"8719aabe-46df-40db-b05a-df08420bad2b:indexpattern-datasource-layer-77618a1a-3e11-4d04-aa8e-147eddb8a7cc","type":"index-pattern"},{"id":"metrics-*","name":"8719aabe-46df-40db-b05a-df08420bad2b:a6727c55-9e4c-4442-9e04-fbd50964f5ee","type":"index-pattern"},{"id":"metrics-*","name":"8676c67a-fb41-44c6-a1c7-fdf12a8f11ae:indexpattern-datasource-layer-5ecc3fa0-861c-4d6f-8baf-4e6ec46aa94c","type":"index-pattern"},{"id":"metrics-*","name":"8676c67a-fb41-44c6-a1c7-fdf12a8f11ae:344d82d5-26a4-4ef8-9e25-b25d3628d053","type":"index-pattern"},{"id":"metrics-*","name":"controlGroup_71a9cbfe-41bf-41b7-a687-ca51adc2390d:optionsListDataView","type":"index-pattern"},{"id":"metrics-*","name":"controlGroup_616a10d1-f529-46b6-8f4c-11e6baf78d73:optionsListDataView","type":"index-pattern"}],"type":"dashboard","typeMigrationVersion":"10.2.0","updated_at":"2024-08-09T05:06:31.060Z","version":"WzU5LDFd"}
    {"excludedObjects":[],"excludedObjectsCount":0,"exportedCount":2,"missingRefCount":0,"missingReferences":[]}
---    
apiVersion: batch/v1
kind: Job
metadata:
  name: import-kibana-dashboard
  namespace: elastic
spec:
  template:
    spec:
      containers:
      - name: import-dashboard
        image: curlimages/curl:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          until curl -s http://kibana-kb-http:5601; do
            echo "Waiting for Kibana to be ready..."
            sleep 10
          done
          echo "Kibana is ready!"
          curl -v -H "kbn-xsrf: true" \
            --form file=@/dashboards/export.ndjson \
            --fail-with-body \
            "http://elastic:${ELASTICSEARCH_PASSWORD}@kibana-kb-http:5601/api/saved_objects/_import?overwrite=true"
        env:
        - name: ELASTICSEARCH_PASSWORD
          valueFrom:
            secretKeyRef:
              name: elasticsearch-es-elastic-user
              key: elastic
        volumeMounts:
        - name: dashboard-config
          mountPath: /dashboards
      restartPolicy: OnFailure
      volumes:
      - name: dashboard-config
        configMap:
          name: kibana-dashboard
