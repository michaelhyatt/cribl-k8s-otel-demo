{"created":1760707515398,"modified":1761044313579,"createdBy":"oidc|CriblCorpOkta|00uqbwsz1bzTYiOhK4x7","modifiedBy":"oidc|CriblCorpOkta|00uqbwsz1bzTYiOhK4x7","displayCreatedBy":" ","displayModifiedBy":" ","schedule":{"enabled":false,"cronSchedule":"0 0 * * *","tz":"UTC","keepLastN":2},"groups":{},"name":"Send only the slow traces - Tail based sampling analyzer","elements":[{"config":{"defaultValue":{"earliest":"-1h","latest":"now","timezone":"local"}},"id":"hhwp5zpiv","inputId":"time","type":"input.timerange","layout":{"x":0,"y":0,"w":2,"h":2},"variant":"input","title":"time"},{"config":{"markdown":"# Auto forwarding the slowest traces\n---\n### using the best dynamic threshold\n\nAn hourly calculation is calculating thresholds\n  - 99 percentile (to only send 1% of traces)\n  - 95 percentile (to only send 5% of traces)\n  - static : above 0.5 seconds\n  - dynamic : 5 standard deviation above the average\n\n ### selecting the logs and traces where duration is above the threshold\n\n  - listing the traces with a abnormal duration\n\n ### forwarding the abnormal traces to elastic\n  - using the send command\n"},"id":"ziovtl8ds","layout":{"x":0,"y":0,"w":4,"h":4},"variant":"markdown","type":"markdown.default"},{"config":{},"search":{"type":"inline","query":"dataset=\"otel_traces\" resource.attributes[\"service.name\"]=\"frontend\" name=\"POST /api/checkout\"\n// add duration field calculated from start and end times\n| extend duration = (end_time_unix_nano - start_time_unix_nano) / 1000000000 \n// aggregate by trace_id\n| summarize  _time=findlatest(_time), duration=max(duration) by trace_id \n// only show the top 10 (slowest) transactions\n|extend dataset=\"otel_traces\" |lookup pack(cribl).otel_threshold on dataset","earliest":"$time.earliest$","latest":"$time.latest$","timezone":"$time.timezone$"},"id":"iqe41387q","layout":{"x":0,"y":0,"w":4,"h":2},"type":"chart.column","title":"basesearch","hidePanel":true},{"config":{},"search":{"type":"inline","earliest":"-1h","latest":"now","query":"(dataset=\"$vt_lookups\" lookupFile=\"cribl.otel_threshold\")|project average, stdev, p95, p99, static_threshold, custom_threshold_avg5stdev"},"id":"0luc4n56k","layout":{"x":4,"y":0,"w":8,"h":1},"type":"list.table","title":"Thresholds calculated every hour"},{"config":{},"search":{"type":"inline","query":"|count ","earliest":"-1h","latest":"now","parentSearchId":"ad0mpgtca"},"id":"ienfkeqim","layout":{"x":4,"y":1,"w":2,"h":3},"type":"counter.single","title":"Traces above threshold"},{"config":{"suffix":"%","label":"reduction","applyThreshold":true,"colorThresholds":{"thresholds":[{"color":"#ea103c","threshold":0},{"color":"#88c926","threshold":50}]},"decimals":5},"search":{"type":"inline","query":"|extend threshold=iif(isnotnull(p99),p99,0.5)\n|summarize above=countif(duration>threshold), total=count()\n|extend percent=(1-(above/total))*100|project percent","earliest":"-1h","latest":"now","parentSearchId":"iqe41387q"},"id":"kom4ol4nj","layout":{"x":6,"y":1,"w":3,"h":3},"type":"counter.single","title":"Reduction"},{"config":{"onClickAction":{"type":"Run a new search","search":"(dataset=\"otel_traces\" OR dataset=\"otel_logs\" ) trace_id=$rowData.trace_id\n| send tee=true ${replayURL}"},"axis":{}},"search":{"type":"inline","runMode":"lastRun","query":"${slow_traces_p99}|project-away average, stdev, p99, p95, max, custo*, static*, dataset","earliest":"$time.earliest$","latest":"$time.latest$","timezone":"$time.timezone$"},"id":"ad0mpgtca","layout":{"x":9,"y":1,"w":3,"h":3},"type":"list.table","title":"Traces above threshold (click to send)"},{"config":{},"search":{"type":"inline","query":"|project _time, trace_id, duration, p99, stati*, custom*","earliest":"-1h","latest":"now","parentSearchId":"iqe41387q"},"id":"9pcnb4yp7","layout":{"x":0,"y":4,"w":12,"h":4},"type":"chart.line","title":"Current traces duration VS threshold"}],"cacheTTLSeconds":600}